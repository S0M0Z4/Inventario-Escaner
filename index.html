<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Anuncios - Iglesia</title>
    <style>
        /* ... (todo el CSS se mantiene igual) ... */
    </style>
    
    <!-- Firebase SDK version 12.7.0 -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getDatabase, ref, set, remove, onValue } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
        
        // Tu configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBLASmgZ4vwEyUEJ-A2xx3pihcgvipEaiE",
            authDomain: "iglesia-anuncios.firebaseapp.com",
            databaseURL: "https://iglesia-anuncios-default-rtdb.firebaseio.com",
            projectId: "iglesia-anuncios",
            storageBucket: "iglesia-anuncios.firebasestorage.app",
            messagingSenderId: "6291270000",
            appId: "1:6291270000:web:abb42fefab0c938a1ec7b5"
        };
        
        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Hacer disponible en el scope global
        window.firebaseDatabase = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseRemove = remove;
        window.firebaseOnValue = onValue;
        
        console.log("Firebase inicializado correctamente");
    </script>
</head>
<body>
    <!-- ... (todo el HTML se mantiene igual) ... -->

    <script>
        // Credenciales de administrador
        const ADMIN_CREDENTIALS = {
            username: "Admin",
            password: "Aa.1234#"
        };

        // Estado de la aplicaci√≥n
        let announcements = [];
        let isAdminLoggedIn = false;
        let currentUser = null;
        let currentDepartment = null;
        let deviceId = null;
        let lastView = 'departmentSelection'; // Para manejar navegaci√≥n
        let isProcessing = false; // Para evitar m√∫ltiples operaciones simult√°neas
        let isInitialLoad = true; // Para controlar carga inicial

        // Elementos del DOM (se mantienen igual)
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const adminViewBtn = document.getElementById('adminViewBtn');
        const loginForm = document.getElementById('loginForm');
        const submitLogin = document.getElementById('submitLogin');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const departmentSelection = document.getElementById('departmentSelection');
        const juvenilSelection = document.getElementById('juvenilSelection');
        const clubesSelection = document.getElementById('clubesSelection');
        const announcementFormSection = document.getElementById('announcementFormSection');
        const announcementsSection = document.getElementById('announcementsSection');
        const adminPanel = document.getElementById('adminPanel');
        const backToDepartmentsBtn = document.getElementById('backToDepartmentsBtn');
        const backToJuvenilBtn = document.getElementById('backToJuvenilBtn');
        const backToSelectionBtn = document.getElementById('backToSelectionBtn');
        const backToAnnouncementsBtn = document.getElementById('backToAnnouncementsBtn');
        const backToMainFromAdminBtn = document.getElementById('backToMainFromAdminBtn');
        const createAnnouncementBtn = document.getElementById('createAnnouncementBtn');
        const refreshCloudBtn = document.getElementById('refreshCloudBtn');
        const syncStatus = document.getElementById('syncStatus');
        const syncStatusText = document.getElementById('syncStatusText');
        const connectionStatus = document.getElementById('connectionStatus');
        const connectionStatusText = document.getElementById('connectionStatusText');
        const successModal = document.getElementById('successModal');
        const successTitle = document.getElementById('successTitle');
        const successMessage = document.getElementById('successMessage');
        const successIcon = document.getElementById('successIcon');
        const closeSuccessModal = document.getElementById('closeSuccessModal');

        // Inicializar la aplicaci√≥n
        function initApp() {
            // Establecer fecha m√≠nima en los campos de fecha
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').min = today;
            document.getElementById('editDate').min = today;
            
            // Generar un ID √∫nico para el dispositivo
            if (!localStorage.getItem('deviceId')) {
                deviceId = 'device_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
                localStorage.setItem('deviceId', deviceId);
            } else {
                deviceId = localStorage.getItem('deviceId');
            }
            
            // Generar un ID √∫nico para el usuario actual (si no existe)
            if (!localStorage.getItem('currentUserId')) {
                const userId = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('currentUserId', userId);
            }
            
            currentUser = localStorage.getItem('currentUserId');
            
            // Restaurar el departamento seleccionado desde LocalStorage
            const savedDepartment = localStorage.getItem('selectedDepartment');
            if (savedDepartment) {
                currentDepartment = savedDepartment;
            }
            
            // Mostrar estado de conexi√≥n
            syncStatus.style.display = 'block';
            syncStatusText.textContent = 'Conectando con la base de datos...';
            
            // Cargar anuncios desde Firebase
            loadAnnouncementsFromFirebase();
            
            // Verificar si hay sesi√≥n de administrador activa
            const adminSession = localStorage.getItem('adminSession');
            if (adminSession === 'active') {
                isAdminLoggedIn = true;
                updateLoginUI();
            }
            
            // Configurar event listeners
            setupEventListeners();
            
            // Manejar vista basada en hash de URL
            const hash = window.location.hash.substring(1);
            if (currentDepartment && hash === 'announcements') {
                document.getElementById('currentDepartmentTitle').textContent = `Anuncios: ${currentDepartment}`;
                showView('announcements');
            } else if (hash === 'admin' && isAdminLoggedIn) {
                showView('admin');
            } else {
                // Mostrar vista inicial
                showView('departmentSelection');
            }
            
            isInitialLoad = false;
            
            // Escuchar cambios en el hash de URL
            window.addEventListener('hashchange', handleHashChange);
        }

        // Manejar cambios en el hash de URL
        function handleHashChange() {
            if (isInitialLoad) return;
            
            const hash = window.location.hash.substring(1);
            if (hash === 'announcements' && currentDepartment) {
                document.getElementById('currentDepartmentTitle').textContent = `Anuncios: ${currentDepartment}`;
                showView('announcements');
            } else if (hash === 'admin' && isAdminLoggedIn) {
                showView('admin');
            } else {
                showView('departmentSelection');
            }
        }

        // Actualizar estado de conexi√≥n (se mantiene igual)
        function updateConnectionStatus(connected) {
            if (connected) {
                connectionStatus.className = 'connection-status online';
                connectionStatusText.textContent = '‚úÖ Conectado a la nube';
            } else {
                connectionStatus.className = 'connection-status offline';
                connectionStatusText.textContent = '‚ö†Ô∏è Sin conexi√≥n a la nube';
            }
        }

        // Cargar anuncios desde Firebase (se mantiene igual)
        function loadAnnouncementsFromFirebase() {
            if (!window.firebaseDatabase) {
                console.error("Firebase no est√° inicializado");
                syncStatusText.textContent = 'Error: Firebase no inicializado';
                syncStatus.className = 'message error';
                return;
            }
            
            try {
                // Referencia a la base de datos
                const announcementsRef = window.firebaseRef(window.firebaseDatabase, 'announcements');
                
                // Escuchar cambios en tiempo real
                window.firebaseOnValue(announcementsRef, (snapshot) => {
                    const data = snapshot.val();
                    
                    if (data) {
                        // Convertir objeto a array
                        announcements = Object.values(data);
                        
                        // Ordenar por ID (m√°s reciente primero)
                        announcements.sort((a, b) => b.id - a.id);
                        
                        console.log(`Cargados ${announcements.length} anuncios desde Firebase`);
                        
                        // Actualizar estado de sincronizaci√≥n
                        syncStatusText.textContent = `‚úÖ Sincronizado con la nube (${announcements.length} anuncios)`;
                        syncStatus.className = 'message success';
                        updateConnectionStatus(true);
                        
                        // Actualizar las vistas si est√°n activas
                        updateAllViews();
                        
                    } else {
                        announcements = [];
                        syncStatusText.textContent = '‚úÖ Base de datos vac√≠a';
                        syncStatus.className = 'message info';
                        updateAllViews();
                    }
                }, (error) => {
                    console.error("Error cargando datos de Firebase:", error);
                    syncStatusText.textContent = '‚ö†Ô∏è Error de conexi√≥n con la base de datos';
                    syncStatus.className = 'message error';
                    updateConnectionStatus(false);
                });
                
            } catch (error) {
                console.error("Error en loadAnnouncementsFromFirebase:", error);
                syncStatusText.textContent = '‚ö†Ô∏è Error cr√≠tico de conexi√≥n';
                syncStatus.className = 'message error';
                updateConnectionStatus(false);
            }
        }

        // Actualizar todas las vistas activas (se mantiene igual)
        function updateAllViews() {
            // Si estamos en vista de anuncios, actualizar
            if (announcementsSection.classList.contains('active')) {
                renderAnnouncements();
            }
            
            // Si estamos en vista de admin, actualizar
            if (adminPanel.classList.contains('active')) {
                renderAdminAnnouncements();
            }
        }

        // Guardar anuncios en Firebase (se mantiene igual)
        async function saveAnnouncementToFirebase(announcement) {
            if (!window.firebaseDatabase) {
                console.error("Firebase no est√° inicializado");
                return false;
            }
            
            try {
                // Generar un ID √∫nico para el anuncio si no tiene
                if (!announcement.id) {
                    announcement.id = Date.now();
                }
                
                // Guardar en Firebase
                const announcementRef = window.firebaseRef(window.firebaseDatabase, 'announcements/' + announcement.id);
                await window.firebaseSet(announcementRef, announcement);
                console.log("Anuncio guardado en Firebase:", announcement.id);
                return true;
            } catch (error) {
                console.error("Error guardando en Firebase:", error);
                return false;
            }
        }

        // Eliminar anuncio de Firebase (se mantiene igual)
        async function deleteAnnouncementFromFirebase(id) {
            if (!window.firebaseDatabase) {
                console.error("Firebase no est√° inicializado");
                return false;
            }
            
            try {
                const announcementRef = window.firebaseRef(window.firebaseDatabase, 'announcements/' + id);
                await window.firebaseRemove(announcementRef);
                console.log("Anuncio eliminado de Firebase:", id);
                return true;
            } catch (error) {
                console.error("Error eliminando de Firebase:", error);
                return false;
            }
        }

        // Mostrar modal de √©xito (se mantiene igual)
        function showSuccessModal(title, message, icon = "‚úì") {
            successTitle.textContent = title;
            successMessage.textContent = message;
            successIcon.textContent = icon;
            successModal.classList.add('active');
        }

        // Configurar event listeners (se mantiene igual excepto por el hashchange)
        function setupEventListeners() {
            // ... (todos los event listeners se mantienen igual) ...
        }

        // Funci√≥n para volver atr√°s (se mantiene igual)
        function goBack() {
            if (announcementFormSection.classList.contains('active')) {
                // Si estamos en formulario, volver a anuncios
                showView('announcements');
            } else if (announcementsSection.classList.contains('active')) {
                // Si estamos en anuncios, volver a selecci√≥n
                if (currentDepartment === "JA") {
                    showView('juvenil');
                } else if (["Aventureros", "Conquistadores", "Gu√≠as Mayores"].includes(currentDepartment)) {
                    showView('clubes');
                } else {
                    showView('departmentSelection');
                }
            } else if (clubesSelection.style.display === 'block') {
                // Si estamos en clubes, volver a juvenil
                showView('juvenil');
            } else if (juvenilSelection.style.display === 'block') {
                // Si estamos en juvenil, volver a departamentos
                showView('departmentSelection');
            } else if (adminPanel.classList.contains('active')) {
                // Si estamos en admin, volver a departamentos
                showView('departmentSelection');
            }
        }

        // Manejar login de administrador (se mantiene igual)
        function handleLogin() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value;
            
            if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
                isAdminLoggedIn = true;
                localStorage.setItem('adminSession', 'active');
                updateLoginUI();
                showSuccessModal('¬°Sesi√≥n Iniciada!', 'Sesi√≥n de administrador iniciada correctamente.', 'üîê');
                loginForm.classList.remove('active');
                usernameInput.value = '';
                passwordInput.value = '';
            } else {
                showMessage('Credenciales incorrectas. Intenta nuevamente.', 'error');
            }
        }

        // Manejar logout de administrador (se mantiene igual)
        function handleLogout() {
            isAdminLoggedIn = false;
            localStorage.removeItem('adminSession');
            updateLoginUI();
            showSuccessModal('¬°Sesi√≥n Cerrada!', 'Sesi√≥n de administrador cerrada correctamente.', 'üö™');
            
            // Volver a vista de departamentos
            showView('departmentSelection');
        }

        // Actualizar la UI seg√∫n el estado de login (se mantiene igual)
        function updateLoginUI() {
            if (isAdminLoggedIn) {
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
                adminViewBtn.style.display = 'block';
            } else {
                loginBtn.style.display = 'block';
                logoutBtn.style.display = 'none';
                adminViewBtn.style.display = 'none';
            }
        }

        // Mostrar diferentes vistas
        function showView(view) {
            // Guardar la vista anterior
            if (view !== lastView) {
                lastView = getCurrentView();
            }
            
            // Ocultar todas las vistas primero
            hideAllViews();
            
            // Mostrar la vista correspondiente
            if (view === 'departmentSelection') {
                departmentSelection.style.display = 'block';
                document.getElementById('welcomeMessage').style.display = 'block';
                // Limpiar el departamento seleccionado cuando volvemos a la selecci√≥n
                localStorage.removeItem('selectedDepartment');
                currentDepartment = null;
                window.location.hash = '';
            } else if (view === 'juvenil') {
                juvenilSelection.style.display = 'block';
                // Limpiar departamento si estamos en selecci√≥n
                localStorage.removeItem('selectedDepartment');
                currentDepartment = null;
                window.location.hash = '';
            } else if (view === 'clubes') {
                clubesSelection.style.display = 'block';
                // Limpiar departamento si estamos en selecci√≥n
                localStorage.removeItem('selectedDepartment');
                currentDepartment = null;
                window.location.hash = '';
            } else if (view === 'form') {
                announcementFormSection.classList.add('active');
                document.getElementById('formSectionTitle').textContent = `Crear Anuncio para: ${currentDepartment}`;
                document.getElementById('selectedDepartment').value = currentDepartment;
                window.location.hash = 'form';
            } else if (view === 'announcements') {
                announcementsSection.classList.add('active');
                // Asegurarnos de que el t√≠tulo sea correcto
                if (currentDepartment) {
                    document.getElementById('currentDepartmentTitle').textContent = `Anuncios: ${currentDepartment}`;
                }
                renderAnnouncements();
                window.location.hash = 'announcements';
            } else if (view === 'admin') {
                adminPanel.classList.add('active');
                renderAdminAnnouncements();
                window.location.hash = 'admin';
            }
        }

        // Obtener vista actual (se mantiene igual)
        function getCurrentView() {
            if (departmentSelection.style.display === 'block') return 'departmentSelection';
            if (juvenilSelection.style.display === 'block') return 'juvenil';
            if (clubesSelection.style.display === 'block') return 'clubes';
            if (announcementFormSection.classList.contains('active')) return 'form';
            if (announcementsSection.classList.contains('active')) return 'announcements';
            if (adminPanel.classList.contains('active')) return 'admin';
            return 'departmentSelection';
        }

        // Ocultar todas las vistas (se mantiene igual)
        function hideAllViews() {
            departmentSelection.style.display = 'none';
            juvenilSelection.style.display = 'none';
            clubesSelection.style.display = 'none';
            announcementFormSection.classList.remove('active');
            announcementsSection.classList.remove('active');
            adminPanel.classList.remove('active');
            document.getElementById('welcomeMessage').style.display = 'none';
        }

        // Seleccionar un departamento
        function selectDepartment(department) {
            currentDepartment = department;
            // Guardar en LocalStorage
            localStorage.setItem('selectedDepartment', department);
            document.getElementById('currentDepartmentTitle').textContent = `Anuncios: ${department}`;
            showView('announcements');
        }

        // Mostrar vista de administrador (se mantiene igual)
        function showAdminView() {
            if (!isAdminLoggedIn) {
                showMessage('Debes iniciar sesi√≥n como administrador primero.', 'error');
                loginForm.classList.add('active');
                return;
            }
            
            showView('admin');
        }

        // Manejar env√≠o de nuevo anuncio
        async function handleAnnouncementSubmit(e) {
            e.preventDefault();
            
            if (isProcessing) return;
            isProcessing = true;
            
            // Obtener valores del formulario
            const department = document.getElementById('selectedDepartment').value;
            const time = document.getElementById('time').value;
            const title = document.getElementById('title').value.trim();
            const description = document.getElementById('description').value.trim();
            const date = document.getElementById('date').value;
            const author = document.getElementById('author').value.trim();
            
            // Validar campos
            if (!time || !title || !description || !date || !author) {
                showMessage('Por favor completa todos los campos.', 'error');
                isProcessing = false;
                return;
            }
            
            // Mostrar estado de carga
            document.getElementById('submitBtnText').textContent = 'Publicando...';
            document.getElementById('submitLoading').style.display = 'inline-block';
            document.getElementById('submitAnnouncementBtn').disabled = true;
            
            // Crear nuevo anuncio
            const newAnnouncement = {
                id: Date.now(), // Usar timestamp como ID √∫nico
                department,
                time,
                title,
                description,
                date: date,
                author: author,
                authorId: currentUser,
                deviceId: deviceId,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // Intentar guardar en Firebase
            const firebaseSuccess = await saveAnnouncementToFirebase(newAnnouncement);
            
            // Restaurar bot√≥n
            document.getElementById('submitBtnText').textContent = 'Publicar Anuncio';
            document.getElementById('submitLoading').style.display = 'none';
            document.getElementById('submitAnnouncementBtn').disabled = false;
            isProcessing = false;
            
            if (firebaseSuccess) {
                // Limpiar formulario (excepto el nombre del autor)
                document.getElementById('time').value = '';
                document.getElementById('title').value = '';
                document.getElementById('date').value = '';
                document.getElementById('description').value = '';
                
                // Mostrar modal de √©xito
                showSuccessModal(
                    '¬°Anuncio Publicado!', 
                    'Tu anuncio se ha publicado exitosamente. La p√°gina se recargar√° autom√°ticamente.',
                    'üì¢'
                );
                
                // Recargar la p√°gina despu√©s de 2 segundos
                setTimeout(() => {
                    // Limpiar hash de URL y departamento seleccionado
                    window.location.hash = '';
                    localStorage.removeItem('selectedDepartment');
                    currentDepartment = null;
                    window.location.reload();
                }, 2000);
                
            } else {
                showMessage('Error al publicar el anuncio. Intenta nuevamente.', 'error');
            }
        }

        // Manejar edici√≥n de anuncio
        async function handleEditAnnouncement(e) {
            e.preventDefault();
            
            if (isProcessing) return;
            isProcessing = true;
            
            // Obtener valores del formulario
            const id = parseInt(document.getElementById('editId').value);
            const time = document.getElementById('editTime').value;
            const title = document.getElementById('editTitle').value.trim();
            const description = document.getElementById('editDescription').value.trim();
            const date = document.getElementById('editDate').value;
            const author = document.getElementById('editAuthorDisplay').value.trim();
            
            // Validar campos
            if (!time || !title || !description || !date || !author) {
                showMessage('Por favor completa todos los campos.', 'error');
                isProcessing = false;
                return;
            }
            
            // Mostrar estado de carga
            document.getElementById('saveEditText').textContent = 'Guardando...';
            document.getElementById('saveEditLoading').style.display = 'inline-block';
            document.getElementById('saveEditBtn').disabled = true;
            
            // Buscar el anuncio a editar
            const announcement = announcements.find(ann => ann.id === id);
            
            if (announcement) {
                // Crear anuncio actualizado
                const updatedAnnouncement = {
                    ...announcement,
                    time,
                    title,
                    description,
                    date,
                    author,
                    updatedAt: new Date().toISOString()
                };
                
                // Guardar en Firebase
                const firebaseSuccess = await saveAnnouncementToFirebase(updatedAnnouncement);
                
                // Restaurar bot√≥n
                document.getElementById('saveEditText').textContent = 'Guardar Cambios';
                document.getElementById('saveEditLoading').style.display = 'none';
                document.getElementById('saveEditBtn').disabled = false;
                isProcessing = false;
                
                if (firebaseSuccess) {
                    // Cerrar panel de edici√≥n
                    closeEditPanel();
                    
                    // Mostrar modal de √©xito
                    showSuccessModal(
                        '¬°Anuncio Actualizado!', 
                        'El anuncio se ha actualizado exitosamente. La p√°gina se recargar√° autom√°ticamente.',
                        '‚úèÔ∏è'
                    );
                    
                    // Recargar la p√°gina despu√©s de 2 segundos
                    setTimeout(() => {
                        // Limpiar hash de URL y departamento seleccionado
                        window.location.hash = '';
                        localStorage.removeItem('selectedDepartment');
                        currentDepartment = null;
                        window.location.reload();
                    }, 2000);
                    
                } else {
                    showMessage('Error al actualizar el anuncio. Intenta nuevamente.', 'error');
                }
            } else {
                document.getElementById('saveEditText').textContent = 'Guardar Cambios';
                document.getElementById('saveEditLoading').style.display = 'none';
                document.getElementById('saveEditBtn').disabled = false;
                isProcessing = false;
                showMessage('El anuncio no se encontr√≥.', 'error');
            }
        }

        // Abrir panel de edici√≥n para un anuncio espec√≠fico (se mantiene igual)
        function openEditPanel(id) {
            // Buscar el anuncio
            const announcement = announcements.find(ann => ann.id === id);
            
            if (announcement) {
                // Llenar el formulario con los datos del anuncio
                document.getElementById('editId').value = announcement.id;
                document.getElementById('editAuthorDisplay').value = announcement.author;
                document.getElementById('editDepartment').value = announcement.department;
                document.getElementById('editTime').value = announcement.time;
                document.getElementById('editTitle').value = announcement.title;
                document.getElementById('editDate').value = announcement.date;
                document.getElementById('editDescription').value = announcement.description;
                
                // Mostrar el panel de edici√≥n
                document.getElementById('editPanel').classList.add('active');
            }
        }

        // Cerrar panel de edici√≥n (se mantiene igual)
        function closeEditPanel() {
            document.getElementById('editPanel').classList.remove('active');
            document.getElementById('editAnnouncementForm').reset();
            
            // Restaurar texto del bot√≥n por si acaso
            document.getElementById('saveEditText').textContent = 'Guardar Cambios';
            document.getElementById('saveEditLoading').style.display = 'none';
            document.getElementById('saveEditBtn').disabled = false;
        }

        // Eliminar un anuncio
        async function deleteAnnouncement(id) {
            if (isProcessing) return;
            
            if (confirm('¬øEst√°s seguro de que quieres eliminar este anuncio?')) {
                isProcessing = true;
                
                // Intentar eliminar de Firebase
                const firebaseSuccess = await deleteAnnouncementFromFirebase(id);
                
                isProcessing = false;
                
                if (firebaseSuccess) {
                    // Mostrar modal de √©xito
                    showSuccessModal(
                        '¬°Anuncio Eliminado!', 
                        'El anuncio se ha eliminado exitosamente. La p√°gina se recargar√° autom√°ticamente.',
                        'üóëÔ∏è'
                    );
                    
                    // Recargar la p√°gina despu√©s de 2 segundos
                    setTimeout(() => {
                        // Limpiar hash de URL y departamento seleccionado
                        window.location.hash = '';
                        localStorage.removeItem('selectedDepartment');
                        currentDepartment = null;
                        window.location.reload();
                    }, 2000);
                    
                } else {
                    showMessage('Error al eliminar el anuncio. Intenta nuevamente.', 'error');
                }
            }
        }

        // Renderizar anuncios del departamento actual
        function renderAnnouncements() {
            const emptyMessage = document.getElementById('emptyMessage');
            const announcementsContainer = document.getElementById('announcementsContainer');
            
            // Si no hay departamento seleccionado, mostrar mensaje
            if (!currentDepartment) {
                emptyMessage.textContent = 'Por favor selecciona un departamento primero.';
                emptyMessage.style.display = 'block';
                announcementsContainer.innerHTML = '';
                announcementsContainer.appendChild(emptyMessage);
                return;
            }
            
            // Filtrar anuncios del departamento actual
            let departmentAnnouncements = announcements.filter(ann => ann.department === currentDepartment);
            
            // Mostrar mensaje si no hay anuncios
            if (departmentAnnouncements.length === 0) {
                emptyMessage.textContent = `No hay anuncios para ${currentDepartment}. ¬°Crea el primer anuncio!`;
                emptyMessage.style.display = 'block';
                announcementsContainer.innerHTML = '';
                announcementsContainer.appendChild(emptyMessage);
                return;
            }
            
            // Ocultar mensaje de vac√≠o
            emptyMessage.style.display = 'none';
            
            // Generar HTML de los anuncios
            let announcementsHTML = '';
            
            // Ordenar por fecha (m√°s cercana primero)
            const sortedAnnouncements = [...departmentAnnouncements].sort((a, b) => {
                return new Date(a.date) - new Date(b.date);
            });
            
            sortedAnnouncements.forEach(announcement => {
                const createdDate = new Date(announcement.createdAt);
                const formattedDate = createdDate.toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                announcementsHTML += `
                    <div class="announcement-card" id="announcement-${announcement.id}">
                        <h3>${announcement.title}</h3>
                        <div class="announcement-category">${announcement.department}</div>
                        <div class="announcement-meta">
                            <span><strong>Hora:</strong> ${announcement.time}</span>
                            <span><strong>Fecha:</strong> ${announcement.date}</span>
                        </div>
                        <div class="announcement-description">
                            ${announcement.description}
                        </div>
                        <div class="announcement-author">
                            <strong>Publicado por:</strong> ${announcement.author}
                            <span style="font-size: 0.7rem; color: #666; display: block; margin-top: 0.2rem;">
                                Publicado el: ${formattedDate}
                            </span>
                        </div>
                    </div>
                `;
            });
            
            announcementsContainer.innerHTML = announcementsHTML;
        }

        // Renderizar todos los anuncios en el panel de administrador (se mantiene igual)
        function renderAdminAnnouncements() {
            // Mostrar mensaje si no hay anuncios
            const adminEmptyMessage = document.getElementById('adminEmptyMessage');
            const adminAnnouncementsContainer = document.getElementById('adminAnnouncements');
            
            if (announcements.length === 0) {
                adminEmptyMessage.style.display = 'block';
                adminAnnouncementsContainer.innerHTML = '';
                adminAnnouncementsContainer.appendChild(adminEmptyMessage);
                return;
            }
            
            // Ocultar mensaje de vac√≠o
            adminEmptyMessage.style.display = 'none';
            
            // Generar HTML de los anuncios
            let adminAnnouncementsHTML = '';
            
            // Ordenar por departamento y fecha
            const sortedAnnouncements = [...announcements].sort((a, b) => {
                if (a.department === b.department) {
                    return new Date(a.date) - new Date(b.date);
                }
                return a.department.localeCompare(b.department);
            });
            
            sortedAnnouncements.forEach(announcement => {
                const createdDate = new Date(announcement.createdAt);
                const formattedDate = createdDate.toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                adminAnnouncementsHTML += `
                    <div class="announcement-card" id="admin-announcement-${announcement.id}">
                        <div class="announcement-actions">
                            <button class="action-btn edit-btn" onclick="openEditPanel(${announcement.id})">
                                ‚úèÔ∏è
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteAnnouncement(${announcement.id})">
                                üóëÔ∏è
                            </button>
                        </div>
                        <h3>${announcement.title}</h3>
                        <div class="announcement-category">${announcement.department}</div>
                        <div class="announcement-meta">
                            <span><strong>Hora:</strong> ${announcement.time}</span>
                            <span><strong>Fecha:</strong> ${announcement.date}</span>
                        </div>
                        <div class="announcement-description">
                            ${announcement.description}
                        </div>
                        <div class="announcement-author">
                            <strong>Publicado por:</strong> ${announcement.author}
                            <span style="font-size: 0.7rem; color: #666;">
                                (Dispositivo: ${announcement.deviceId?.substring(0, 8)}...)
                            </span>
                            <span style="font-size: 0.7rem; color: #666; display: block; margin-top: 0.2rem;">
                                Publicado el: ${formattedDate}
                            </span>
                        </div>
                    </div>
                `;
            });
            
            adminAnnouncementsContainer.innerHTML = adminAnnouncementsHTML;
        }

        // Mostrar mensajes temporales (se mantiene igual)
        function showMessage(text, type) {
            const formMessage = document.getElementById('formMessage');
            formMessage.textContent = text;
            formMessage.className = `message ${type}`;
            
            // Ocultar mensaje despu√©s de 3 segundos
            setTimeout(() => {
                formMessage.style.display = 'none';
            }, 3000);
        }

        // Inicializar la aplicaci√≥n cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
